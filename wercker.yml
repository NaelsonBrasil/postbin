box: node:4

build:
  steps:
    - npm-install
    - npm-test

deploy:
  steps:
    # Add our deploy key to SSH
    - add-ssh-key:
      keyname: GIT_KEY

    # Add GitHub's SSH fingerprint to SSH known_hosts
    - add-to-known_hosts:
      hostname: github.com
      fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
      type: rsa

    # Configure npm to allow root scripts
    # https://docs.npmjs.com/misc/config#unsafe-perm
    - script:
      name: Enable root/sudo for npm
      code: npm config set unsafe-perm true --global

    # Restore symlinks from npm install in build phase
    - script:
      name: Rebuild links
      code: npm rebuild

    # Generate new tag/version
    # - script:
    #   name: Automatically generate a new tag/version
    #   code: npm run-script bump

    # Publish to npm
    - turistforeningen/npm-publish

    # Push Tags back to GitHub.com
    # - script:
    #   name: Push Tags to GitHub.com
    #   code: npm run-script push
